\chapter{Embedded Linux}


% Vada per l'opzione a) Nel frattempo ho realizzato che il supporto per
% Ganador rev.4 era stato completato dal collega Giandomenico, chiedo
% venia è un po' che non tocco questo progetto. Quindi un problema in meno.

% Il sistema embedded che ti forniremo è costituito da una host-board
% chiamata Ganador (rev.4) e un system-on-module (SoM) chiamato
% Vulcano-A5. A completare il tutto un display da 7" connesso tramite
% l'interfaccia TTL e dotato di touchscreen resistivo.

% Allego i diagrammi a blocchi di SoM e host-board.

% Nel file vulcano-sw.pdf allegato trovi della documentazione riguardo
% l'intero sistema che si compone di varie parti, buildroot, AT91boot
% (bootloader di secondo livello), Barebox (bootloader di terzo livello) e
% Linux.

% Quando fu scritta quella documentazione Linux, AT91boot e Barebox
% venivano compilati esternamente da buildroot ma sempre tramite il
% cross-compilatore compilato da buildroot.

% Giandomenico in occasione del porting di Vulcano-A5 su Ganador ha
% integrato tutto quanto in buildroot
% (git.amelchem.com:amel/buildroot.git), il suo branch è vulcano-uni ma
% non l'ho mai revisionato in quanto il progetto Ganador si era
% temporaneamente arenato. Ho appena sistemato i commit e fatto push nel
% branch "Vulcano", dovrebbe essere tutto in ordine ma non ho compilato
% quindi non ci metto la mano sul fuoco.

% Dovresti essere in grado di compilare tutto quanto ti serve con:

% git clone git://git.buildroot.net/buildroot
% cd buildroot
% git remote add amel git@git.amelchem.com:amel/buildroot.git
% git fetch amel
% git checkout Vulcano

% make vulcanoa5_defconfig
% make -j$(nproc)

% Armati di pazienza perché partirà una lunga compilazione, prima degli
% host tool, quindi tutto quanto ti servirà per cross-compilare (gcc e
% libc in primis), poi del kernel, busybox e i pochi altri pacchetti
% abilitati.

% Questo il manuale di buildroot:
% https://buildroot.org/downloads/manual/manual.html

% Bada che nel defconfig di vulcano viene abilitato qt5 come dipendenza di
% una piccola applicazione dimostrativa: amel-qt5app. A te non serve, puoi
% disabilitare l'intera libreria QT andando ad eliminare le varie righe
% QT5BASE_ dal tuo .config locale o tramite make menuconfig, consiglio
% definisciti un tuo defconfig a partire da vulcanoa5_defconfig con tutti
% i pacchetti che ti servono (vedi paragrafo della documentazione 9.3.
% Storing the Buildroot configuration). Recupererai diversi minuti di
% compilazione spegnendo qt5.

% Giunti a questo punto dovrai aggiungere il pacchetto della tua
% applicazione a buildroot, vedi a tal proposito la documentazione di
% buildroot al paragrafo:
% https://buildroot.org/downloads/manual/manual.html#adding-packages. Vedi
% anche esempio amel-qt5app con git show 01e31e1fc4

% Nel frattempo ti faccio preparare un kit con Ganador, Vulcano-A5,
% Display e sonda termica che basata su DS18B20 il quale parla 1-wire ma
% lo collegheremo tramite un adattatore USB a Ganador perché purtroppo non
% ci sono GPIO bidirezionali del SoC esposti direttamente altrimenti si
% sarebbe potuto usare uno di quelli.

% Tutto chiaro?

% Non spaventarti, per dubbi o perplessità scrivimi.


\section{Hardware}
La scheda utilizzata per il sistema embedded è sviluppata da AMEL ed è composta da:
\begin{itemize}
    \item una host-board Ganador (rev.4)
    \item un system-on-module Vulcano-A5
    \item una cpu ARM.
    \item una memoria SD usata come disco fisso.
    \item un interfaccia ethernet.
    \item un interfaccia seriale.
    \item un display touchscreen.
\end{itemize}

\section{Building the system}
Per orchestrare il sistema è stato utilizzato Linux. È stato creato un kernel ad hoc con solo i moduli essenziali per il funzionamento a causa delle limitate risorse hardware. Il tool utilizzato per completare l'opera è stato buildroot\cite{buildroot}. Esso è essenzialmente una lista di Makefile per installare e cross compilare tutte le librerie e pacchetti necessari per costruire e far girare il sistema. Si occupa inoltre di creare il filesystem e flasharlo in un'immagine pronta per essere scritta sulla scheda SD da inserire nel sistema embedded. 

Per aggiungere l'interfaccia grafica creata con LVGL é stato necessario creare un nuovo package in buildroot

All'avvio del sistema, il bootloader del chip avvia AT91bootstrap che a sua volta avvia barebox che a sua volta carica il kernel in memoria.

\subsection{Installazione di un pacchetto in Buildroot}
\label{EmbeddedLinux:Buildroot}
Per aggiungere un pacchetto a buildroot è necessario aggiungere una nuova entry nella cartella \texttt{package} contenente un file \texttt{Config.in} ed un file \texttt{.mk}.

Questi due file contengono le istruzioni che permettono a buildroot di risolvere dipendenze, scaricare ed installare il pacchetto nel filesystem del target device.


\newpage

\begin{table}
\begin{minted}{bash}
AMEL_TEMP_CONTROL_VERSION = 44c17c6f2c492f1f3c7d8a6767df390c8d13eb9c
AMEL_TEMP_CONTROL_SITE = git@git.amelchem.com:mpapaccioli/temp-control.git
AMEL_TEMP_CONTROL_SITE_METHOD = git

AMEL_TEMP_CONTROL_DEPENDENCIES = libevdev
AMEL_TEMP_CONTROL_GIT_SUBMODULES = YES

define AMEL_TEMP_CONTROL_BUILD_CMDS
	cmake -DCMAKE_TOOLCHAIN_FILE=$(@D)/user_cross_compile_setup.cmake \
        -B $(@D)/build -S $(@D)
	make -C $(@D)/build -j

endef

define AMEL_TEMP_CONTROL_INSTALL_TARGET_CMDS
 	$(INSTALL) -d $(TARGET_DIR)/opt/amel-temp-control/
	cp $(@D)/build/bin/lvglsim $(TARGET_DIR)/opt/amel-temp-control/main
	cp -r $(@D)/build/lvgl/lib/* $(TARGET_DIR)/usr/lib
	
endef

$(eval $(generic-package))
\end{minted}
\caption{\texttt{amel-temp-control.mk}}
\end{table}

Inizialmente, viene clonata la repository temp-control, contenente la GUI, al commit specificato, inizializzando i submodules e verificando la presenza della dipendenze \texttt{libevdev}. 

Successivamente, viene cross compilata la libreria LVGL e l'applicazione con interfaccia grafica con il compilatore arm installato nella macchina target.

Infine, vengono installati i binari della libreria e l'eseguibile dell'app sulla macchina target.

Dopo aver fatto cio per tutti i pacchetti desisderati, il filesystem e l'immagine del kernel vengono scritti in un file \texttt{sdcard.img} pronto per essere flashato su una scheda sd e fatto partire sull'embedded device.


\section{File I/O}

\section{PID Control}


\section{MODBUS RTU}